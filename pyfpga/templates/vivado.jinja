#
# PyFPGA
# Copyright (C) 2015-2024 Rodrigo A. Melo
#
# SPDX-License-Identifier: GPL-3.0-or-later
#

set PRESYNTH {{ PRESYNTH }}
set PROJECT  {{ PROJECT }}
set PART     {{ PART }}
set FAMILY   {{ FAMILY }}
set DEVICE   {{ DEVICE }}
set PACKAGE  {{ PACKAGE }}
set SPEED    {{ SPEED }}
set TOP      {{ TOP }}

set PARAMS   [list {{ PARAMS }}]

proc fpga_files {} {
{{ FILES }}
}

proc fpga_file {FILE {LIBRARY "work"}} {
    set message "adding the file '$FILE'"
    if { $LIBRARY != "work" } { append message " (into the VHDL library '$LIBRARY')" }
    regexp -nocase {\.(\w*)$} $FILE -> ext
    if { $ext == "tcl" } {
        source $FILE
        return
    }
    if { $LIBRARY != "work" } {
        add_files $FILE
        set_property library $LIBRARY [get_files $FILE]
    } else {
        add_files $FILE
    }
}

proc fpga_include {PATH} {
    lappend INCLUDED $PATH
    # Verilog Included Files are NOT added
    set_property "include_dirs" $INCLUDED [current_fileset]
}

proc fpga_params {} {
    if { [llength $PARAMS] == 0 } { return }
    set assigns [list]
    foreach PARAM $PARAMS { lappend assigns [join $PARAM "="] }
    set obj [get_filesets sources_1]
    set_property "generic" "[join $assigns]" -objects $obj
}

#------------------------------------------------------------------------------

{% if PRJ %}
create_project -force $PROJECT

set_property "part" $PART [current_project]

{{ PRECFG }}

fpga_files

set_property top $TOP [current_fileset]

fpga_params

{{ POSTCFG }}

close_project
{% endif %}

{% if SYN or PAR or BIT %}
open_project $PROJECT

{% if SYN %}
{{ PRESYN }}

if { $PRESYNTH == "True" } {
    set_property design_mode GateLvl [current_fileset]
} else {
    reset_run synth_1
    launch_runs synth_1
    wait_on_run synth_1
}

{{ POSTSYN }}
{% endif %}

{% if PAR %}
{{ PREPAR }}

if {$PRESYNTH == "False"} {
    open_run synth_1
}
launch_runs impl_1
wait_on_run impl_1

{{ POSTPAR }}
{% endif %}

{% if BIT %}
{{ PREBIT }}

open_run impl_1
write_bitstream -force $PROJECT

{{ POSTBIT }}
{% endif %}

close_project
{% endif %}
