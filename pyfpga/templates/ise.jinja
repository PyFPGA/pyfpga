{#
#
# Copyright (C) 2015-2024 Rodrigo A. Melo
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
#}

{# ------------------------------------------------------------------------- #}
{# Project configuration                                                     #}
{# ------------------------------------------------------------------------- #}

{% if CFG %}

if { [ file exists {{ PROJECT }}.xise ] } { file delete {{ PROJECT }}.xise }
project new {{ PROJECT }}.xise
project set family  {{ FAMILY }}
project set device  {{ DEVICE }}
project set package {{ PACKAGE }}
project set speed  -{{ SPEED }}

{{ PRECFG }}

{% if FILES %}
{% for name, attr in FILES.items() %}
{% if 'lib' in attr %}lib_vhdl new {{ attr.lib }}{% endif %}
xfile add {{ name }}{% if 'lib' in attr %} -lib_vhdl {{ attr.lib }}{% endif %}
{% endfor %}
{% endif %}

{% if CONSTRAINTS %}
{% for name, attr in CONSTRAINTS.items() %}
{% set name_str = name|string %}
xfile add {{ name_str }}
{% if name_str.endswith('.xcf') %}
project set "Synthesis Constraints File" "{{ name_str }}" -process "Synthesize - XST"
{% endif %}
{% endfor %}
{% endif %}

{% if TOP %}
project set top {{ TOP }}
{% endif %}

{% if INCLUDES %}
project set "Verilog Include Directories" "{{ INCLUDES | join('|') }}" -process "Synthesize - XST"
{% endif %}

{% if DEFINES %}
project set "Verilog Macros" "{{ DEFINES.items() | map('join', '=') | join(' | ') }}" -process "Synthesize - XST"
{% endif %}

{% if PARAMS %}
project set "Generics, Parameters" "{{ PARAMS.items() | map('join', '=') | join(' ') }}" -process "Synthesize - XST"
{% endif %}

{{ POSTCFG }}

project close

{% endif %}

{# ------------------------------------------------------------------------- #}
{# Design flow                                                               #}
{# ------------------------------------------------------------------------- #}

{% if SYN or PAR or BIT %}

project open {{ PROJECT }}.xise

{# Synthesis --------------------------------------------------------------- #}

{% if SYN %}

{{ PRESYN }}

# PRESYNTH
#project set top_level_module_type "EDIF"
project clean
process run "Synthesize"
if { [process get "Synthesize" status] == "errors" } { exit 1 }

{{ POSTSYN }}

{% endif %}

{# Place and Route --------------------------------------------------------- #}

{% if PAR %}

{{ PREPAR }}

process run "Translate"
if { [process get "Translate" status] == "errors" } { exit 1 }
process run "Map"
if { [process get "Map" status] == "errors" } { exit 1 }
process run "Place & Route"
if { [process get "Place & Route" status] == "errors" } { exit 1 }

{{ POSTPAR }}

{% endif %}

{# Bitstream generation ---------------------------------------------------- #}

{% if BIT %}

{{ PREBIT }}

process run "Generate Programming File"
if { [process get "Generate Programming File" status] == "errors" } { exit 1 }
catch { file rename -force {{ TOP }}.bit {{ PROJECT }}.bit }

{{ POSTBIT }}

{% endif %}

{# ------------------------------------------------------------------------- #}

project close

{% endif %}
