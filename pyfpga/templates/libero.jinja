{#
#
# Copyright (C) 2015-2024 PyFPGA Project
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
#}

{% if CFG %}# Project configuration -------------------------------------------------------

if { [ file exists {{ PROJECT }} ] } { file delete -force -- {{ PROJECT }} }
new_project -name {{ PROJECT }} -location {libero} -hdl {VERILOG} -family {SmartFusion2}
set_device -family {{ FAMILY }} -die {{ DEVICE }} -package {{ PACKAGE }} -speed {{ SPEED }}

{{ PRECFG }}

{% if INCLUDES %}# Verilog Includes (Libero)
set_global_include_path_order -paths "{{ INCLUDES | join(' ') }}"
{% endif %}

{% if FILES %}# Files inclusion
{% for name, attr in FILES.items() %}
create_links -hdl_source {{ name }}{% if 'lib' in attr %} -library {{ attr.lib }}{% endif %}
{% endfor %}
{% endif %}

{% if CONSTRAINTS %}# Constraints inclusion
{% for name, attr in CONSTRAINTS.items() %}
create_links {% if name.endswith('.sdc') %}-sdc{% else %}-io_pdc{% endif %} {{ name }}
{% endfor %}
{% endif %}

build_design_hierarchy

{% if TOP %}# Top-level specification
set_root {{ TOP }}
{% endif %}

{% if CONSTRAINTS %}# Constraints configuration
{% set sdc_files = [] %}
{% set pdc_files = [] %}
{% for name, attr in CONSTRAINTS.items() %}
{% if name.endswith('.sdc') %}
{% set _ = sdc_files.append(name) %}
{% endif %}
{% set _ = pdc_files.append(name) %}
{% endfor %}
{% endif %}

{% if sdc_files %}organize_tool_files -tool {SYNTHESIZE}   -file {{ sdc_files | join(' -file ') }} -module {{ TOP }} -input_type {constraint}{% endif %}
{% if pdc_files %}organize_tool_files -tool {PLACEROUTE}   -file {{ pdc_files | join(' -file ') }} -module {{ TOP }} -input_type {constraint}{% endif %}
{% if sdc_files %}organize_tool_files -tool {VERIFYTIMING} -file {{ sdc_files | join(' -file ') }} -module {{ TOP }} -input_type {constraint}{% endif %}

{% if INCLUDES or DEFINES or PARAMS %}# Synopsys configuration
configure_tool -name {SYNTHESIZE} -params {SYNPLIFY_OPTIONS:

{% if INCLUDES %}# Verilog Includes (Synopsys)
{% for INCLUDE in INCLUDES %}
  set_option -include_path "{{ INCLUDE }}"
{% endfor %}
{% endif %}

{% if DEFINES %}# Verilog Defines (Synopsys)
{% for key, value in DEFINES.items() %}
  set_option -hdl_define -set {{ key }}={{ value }}
{% endfor %}
{% endif %}

{% if PARAMS %}# Verilog Parameters / VHDL Generics (Synopsys)
{% for key, value in PARAMS.items() %}
  set_option -hdl_param -set {{ key }}={{ value }}
{% endfor %}
{% endif %}

}
{% endif %}

{{ POSTCFG }}

close_project

{% endif %}

{% if SYN or PAR or BIT %}# Design flow -----------------------------------------------------------------

open_project {{ PROJECT }}/{{ PROJECT }}.prjx

{% if SYN %}# Synthesis

{{ PRESYN }}

run_tool -name {SYNTHESIZE}

{{ POSTSYN }}

{% endif %}

{% if PAR %}# Place and Route

{{ PREPAR }}

run_tool -name {PLACEROUTE}
run_tool -name {VERIFYTIMING}

{{ POSTPAR }}

{% endif %}

{% if BIT %}# Bitstream generation

{{ PREBIT }}

run_tool -name {GENERATEPROGRAMMINGFILE}

{{ POSTBIT }}

{% endif %}

close_project

{% endif %}
