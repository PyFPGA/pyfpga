{#
#
# Copyright (C) 2020-2024 PyFPGA Project
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
#}

set -e

DOCKER="docker run --user $(id -u):$(id -g) --rm -v $HOME:$HOME -w $PWD"

{% if 'syn' in steps %}# Synthesis
$DOCKER hdlc/ghdl:yosys /bin/bash -c "
{% if hooks %}{{ hooks.presyn | join('\n') }}{% endif %}
yosys -Q -m ghdl -p '

{% if includes %}
verilog_defaults -add{% for path in includes %} -I{{ path }}{% endfor %}
{% endif %}

{% if defines %}
verilog_defines{% for key, value in defines.items() %} -D{{ key }}={{ value }}{% endfor %}
{% endif %}

{% if files %}
{% for name, attr in files.items() %}
{% if attr.hdl == "vlog" %}
read_verilog -defer {{ name }}
{% elif attr.hdl == "slog" %}
read_verilog -defer -sv {{ name }}
{% endif %}
{% endfor %}
{% endif %}

{% if params %}
chparam{% for key, value in params.items() %} -set {{ key }} {{ value }}{% endfor %}
{% endif %}

synth -top {{ top }}
synth_{{ family }} -top {{ top }} -json {{ project }}.json
'
{% if hooks %}{{ hooks.postsyn | join('\n') }}{% endif %}
"
{% endif %}

{#
#SYNTH=
#WRITE=
#if [[ $BACKEND == "vivado" ]]; then
#    SYNTH="synth_xilinx -top $TOP -family $FAMILY"
#    WRITE="write_edif -pvector bra $PROJECT.edif"
#elif [[ $BACKEND == "ise" ]]; then
#    SYNTH="synth_xilinx -top $TOP -family $FAMILY -ise"
#    WRITE="write_edif -pvector bra $PROJECT.edif"
#elif [[ $BACKEND == "nextpnr" ]]; then
#    SYNTH="synth_$FAMILY -top $TOP -json $PROJECT.json"
#elif [[ $BACKEND == "verilog-nosynth" ]]; then
#    WRITE="write_verilog $PROJECT.v"
#else
#    SYNTH="synth -top $TOP"
#    WRITE="write_verilog $PROJECT.v"
#fi
#}

{% if 'par' in steps %}# Place and Route

CONSTRAINTS="{{ constraints | join(' ') }}"

{% if family == 'ice40' %}
if [ -n "$CONSTRAINTS" ]; then
  cat $CONSTRAINTS > constraints.pcf
  CONSTRAINT="--pcf constraints.pcf"
fi
$DOCKER hdlc/nextpnr:ice40 /bin/bash -c "
{% if hooks %}{{ hooks.prepar | join('\n') }}{% endif %}
nextpnr-ice40 --{{ device }} --package {{ package }} $CONSTRAINT --json {{ project }}.json --asc {{ project }}.asc
{% if hooks %}{{ hooks.postpar | join('\n') }}{% endif %}
"
$DOCKER hdlc/icestorm /bin/bash -c "
icetime -d {{ device }} -mtr {{ project }}.rpt {{ project }}.asc
"
{% endif %}

{% if family == 'ecp5' %}
if [ -n "$CONSTRAINTS" ]; then
  cat $CONSTRAINTS > constraints.lpf
  CONSTRAINT="--lpf constraints.lpf"
fi
$DOCKER hdlc/nextpnr:ecp5 /bin/bash -c "
{% if hooks %}{{ hooks.prepar | join('\n') }}{% endif %}
nextpnr-ecp5 --{{ device }} --package {{ package }} $CONSTRAINT --json {{ project }}.json --textcfg {{ project }}.config
{% if hooks %}{{ hooks.postpar | join('\n') }}{% endif %}
"
{% endif %}

{% endif %}

{% if 'bit' in steps %}# Bitstream generation

{% if family == 'ice40' %}
$DOCKER hdlc/icestorm /bin/bash -c "
{% if hooks %}{{ hooks.prebit | join('\n') }}{% endif %}
icepack {{ project }}.asc {{ project }}.bit
{% if hooks %}{{ hooks.postbit | join('\n') }}{% endif %}
"
{% endif %}

{% if family == 'ecp5' %}
$DOCKER hdlc/prjtrellis /bin/bash -c "
{% if hooks %}{{ prebit | join('\n') }}{% endif %}
ecppack --svf {{ project }}.svf {{ project }}.config {{ project }}.bit
{% if hooks %}{{ postbit | join('\n') }}{% endif %}
"
{% endif %}

{% endif %}
